"use strict";function ModelListDirective(e,t,n){return{scope:{model:"="},controller:["$scope",function(o){function i(){o.model=r,o.$emit("MODEL_LOADED",r)}var r;o.currentModelID,o.models=e.getAll(),o.loadModel=function(o){var s=parseInt(o);if(!isNaN(s))switch(r=e.getByID(s),n.resetScene(),r.fileFormat){case ModelFormat.OBJMTL:t.loadObjMtl(r.name,r.filePath,r.params.mtlPath,i);break;case ModelFormat.DAE:t.loadDae(r.name,r.filePath,i)}}}],templateUrl:"app/ModelListPanel/ModelListView.html"}}function ControlsDirective(e){return{scope:{coordinatesEnabled:"=",movementEnabled:"="},controller:["$scope",function(t){t.toggleMovementControls=e.toggleMovementControls}],templateUrl:"app/ControlsPanel/ControlsView.html"}}function HierarchyDirective(e,t,n,o){return{scope:{},controller:["$scope","$timeout",function(o,i){function r(){CollapsibleLists.applyTo(document.getElementById("objectHierarchy"));var e=document.getElementById("hierarchyRoot");e&&e.click()}o.objects=e.getObjectHierarchy();o.$on("UPDATE",function(){i(r,0,!1)}),o.objectMouseOver=function(e){},o.objectMouseOut=function(e){},o.toggleVisibility=function(e,n){n?t.restoreChildVisibility(e,!0):t.hideChildren(e,!0)},o.showObjectInfo=function(e){n.openModal(e)}}],templateUrl:"app/HierarchyPanel/HierarchyView.html"}}function GraphicsService(e,t){function n(){u.render(l,d)}function o(){requestAnimationFrame(o),n()}function i(e){l=new THREE.Scene,h.name="LoadedObjects",l.add(h);var t=document.getElementById(e);u=new THREE.WebGLRenderer({canvas:t});var n=u.domElement.clientWidth,o=u.domElement.clientHeight;u.setSize(n,o),u.setViewport(0,0,n,o),u.setClearColor(14340560),d=new THREE.PerspectiveCamera(75,u.domElement.width/u.domElement.height,v,S),d.position.set(m.x,m.y,m.z),f=new THREE.OrbitControls(d,u.domElement),f.damping=.2;var i;i=new THREE.DirectionalLight(16777215,.8),i.position.set(-7,4.5,3),l.add(i),i=new THREE.DirectionalLight(16777215,.4),i.position.set(5,3.5,4),l.add(i),i=new THREE.DirectionalLight(16777215,.3),i.position.set(0,8,-10),l.add(i),window.addEventListener("resize",r,!0)}function r(){var e=u.domElement.clientWidth,t=u.domElement.clientHeight;d.aspect=e/t,d.updateProjectionMatrix(),u.setSize(e,t),u.setViewport(0,0,e,t)}function s(e,n,o){n.name=e,h.add(n),t(function(){o()},200),n.traverse(function(e){e.name=e.name.replace("_"," ").trim(),e.material&&(e.material.side=THREE.DoubleSide)})}function a(e){var t={x:0,y:0};return t.x=e.offsetX/u.domElement.width*2-1,t.y=2*-(e.offsetY/u.domElement.height)+1,t}function c(e,t){var n=a(t),o=new THREE.Raycaster;return o.setFromCamera(n,e),o.intersectObjects(h.children,!0)}var l,d,u,f,h=new THREE.Object3D,m=new THREE.Vector3(0,40,100),v=.1,S=500;i(e),o(),this.addNonuserObject=function(e){l.add(e)},this.getSceneContainer=function(){return h},this.getCamera=function(){return d},this.getControls=function(){return f},this.resetCamera=function(){d.position.copy(m),f.target.set(0,0,0),f.update(),d.near=v,d.far=S},this.toggleMovementControls=function(e){void 0!=e?f.enabled=e:f.enabled=!f.enabled},this.getMouseWorldCoordinates=function(e){var t=c(d,e);return t.length>0?t[0].point.clone():null},this.getObjectHierarchy=function(){return h.children},this.loadObjMtl=function(e,t,n,o){(new THREE.OBJMTLLoader).load(t,n,function(t){s(e,t,o)},function(e){console.log(e.loaded/e.total*100+"% loaded")},function(e){console.error("Model file "+t+" could not be loaded")})},this.loadDae=function(e,t,n){(new THREE.ColladaLoader).load(t,function(t){s(e,t.scene,n)},function(e){console.log(e.loaded/e.total*100+"% loaded")},function(e){console.error("Model file "+t+" could not be loaded")})}}function SceneUtilsService(e){function t(){var e=new THREE.Box3;e.setFromObject(l),isNaN(e.size().x)||isNaN(e.size().y)||isNaN(e.size().z)||(f=e)}function n(e,t){d.updateProjectionMatrix();var n=d.projectionMatrix,o=t/100*(f.size().z/2),i=new THREE.Plane(e.clone(),-o);i.applyMatrix4(d.matrixWorldInverse);var r=new THREE.Vector4(i.normal.x,i.normal.y,i.normal.z,i.constant),s=new THREE.Vector4;s.x=(Math.sign(r.x)+n.elements[8])/n.elements[0],s.y=(Math.sign(r.y)+n.elements[9])/n.elements[5],s.z=-1,s.w=(1+n.elements[10])/n.elements[14];var a=new THREE.Vector4;a=r.multiplyScalar(2/r.dot(s)),n.elements[2]=a.x,n.elements[6]=a.y,n.elements[10]=a.z+1,n.elements[14]=a.w}function o(){a.crossSection.enabled&&n(a.crossSection.normal,a.crossSection.distance)}function i(e,t){var n=t/100*(f.size().z/2);s.position.set(0,0,0),s.rotation.set(0,0,0),s.translateOnAxis(e,n),s.rotateOnAxis(new THREE.Vector3(1,0,0),a.crossSection.angleX/180*Math.PI),s.rotateOnAxis(new THREE.Vector3(0,1,0),a.crossSection.angleY/180*Math.PI)}function r(){var e=new THREE.PlaneBufferGeometry(1,1),t=new THREE.MeshBasicMaterial({color:15728640,side:THREE.DoubleSide,transparent:!0,opacity:.1});s=new THREE.Mesh(e,t),s.visible=!1,c.addNonuserObject(s),u.addEventListener("change",o)}var s,a=this,c=e,l=c.getSceneContainer(),d=c.getCamera(),u=c.getControls(),f=new THREE.Box3;Math.sign=Math.sign||function(e){return e=+e,0===e||isNaN(e)?e:e>0?1:-1},r(),this.resetScene=function(){for(var e=0;e<l.children.length;e++)l.remove(l.children[e]);t(),a.resetCrossSection(),i(a.crossSection.normal,a.crossSection.distance),c.resetCamera()},this.centerScene=function(){if(t(),f){var e=f.center().multiplyScalar(-1);l.position.add(e),t()}},this.zoomToScene=function(){var e=f,t=.7,n=e.center(),o=e.size().x/t,i=e.size().y/t,r=e.max.z,s=d.fov*(Math.PI/180),a=2*Math.atan(Math.tan(s/2)*d.aspect),c=i/(2*Math.tan(s/2)),l=o/(2*Math.tan(a/2)),h=Math.max(c,l),m=30/180*Math.PI,v=Math.sin(m)*h;d.position.x=n.x,d.position.y=n.y+v,d.position.z=h+r,u.target.copy(n),u.update()},this.scaleObject=function(e,t){var n=l.getObjectByName(e);n&&(n.scale.set(t.x,t.y,t.z),a.centerScene())},this.translateObject=function(e,n){var o=l.getObjectByName(e);o&&(o.translateX(n.x),o.translateY(n.y),o.translateZ(n.z)),t()},this.highlightObject=function(e,t){var n=l.getObjectByName(e);n&&n.traverse(function(e){"material"in e&&(e.materialOrig=e.material.clone(),e.material.color.setHex(t))})},this.unhighlightObject=function(e){var t=l.getObjectByName(e);t&&t.traverse(function(e){"materialOrig"in e&&(e.material=e.materialOrig.clone(),delete e.materialOrig)})},this.showChildren=function(e){e.traverse(function(e){e.visible=!0,delete e.userData.visible})},this.hideChildren=function(e,t){e.traverse(function(n){t&&n==e||"visible"in n.userData||(n.userData.visible=n.visible,n.visible=!1)})},this.restoreChildVisibility=function(e,t){e.traverse(function(n){t&&n==e||"visible"in n.userData&&(n.visible=n.userData.visible,delete n.userData.visible)})},this.isolateObject=function(e){a.stopIsolation(),e.userData.isolated=!0,a.hideChildren(l,!0),a.showChildren(e,!1),e.traverseAncestors(function(e){e.visible=!0})},this.stopIsolation=function(){l.traverse(function(e){delete e.userData.isolated}),a.restoreChildVisibility(l)},this.crossSection={enabled:!1,normal:new THREE.Vector3(0,0,-1),distance:0,angleX:0,angleY:0},this.enableCrossSection=function(e){a.crossSection.enabled=!0,a.crossSection.distance=e,n(a.crossSection.normal,a.crossSection.distance),s.userData.visibility=s.visible,s.visible=!1},this.disableCrossSection=function(){a.crossSection.enabled&&(d.updateProjectionMatrix(),a.crossSection.enabled=!1,s.visible=s.userData.visibility,delete s.userData.visibility)},this.setCrossSectionToObjectPosition=function(e){var t=f.center().clone(),n=new THREE.Box3;n.setFromObject(e);var o=t.z-n.center().z,r=Math.round(2*o/f.size().z*100);a.crossSection.distance=r,i(a.crossSection.normal,a.crossSection.distance)},this.moveCrossSection=function(e){a.crossSection.distance=e,i(a.crossSection.normal,a.crossSection.distance),a.crossSection.enabled&&n(a.crossSection.normal,a.crossSection.distance)},this.rotateCrossSection=function(e,t){var o;o="X"===e?new THREE.Vector3(1,0,0):new THREE.Vector3(0,1,0);var r=t/180*Math.PI;a.crossSection.normal.applyAxisAngle(o,r),i(a.crossSection.normal,a.crossSection.distance),a.crossSection.enabled&&n(a.crossSection.normal,a.crossSection.distance)},this.flipCrossSection=function(){a.crossSection.enabled&&(u.rotateLeft(Math.PI),u.update(),a.crossSection.distance*=-1,a.disableCrossSection(),a.enableCrossSection(a.crossSection.distance))},this.resetCrossSection=function(){a.crossSection.enabled=!1,a.crossSection.normal=new THREE.Vector3(0,0,-1),a.crossSection.distance=0,a.crossSection.angleX=0,a.crossSection.angleY=0,d.updateProjectionMatrix()},this.showCrossSectionPlane=function(e){if(e){i(a.crossSection.normal,a.crossSection.distance),s.scale.set(1,1,1);var t=f.size().multiplyScalar(1.3);s.scale.set(t.x,t.y,1)}s.visible=e}}function ArcGisService(e,t){function n(e){return t.get(r+"?"+e)}function o(){r=e}function i(e){var t=e.trim().replace("_","");return t}var r,s=/^\d{2}(\d{4})?\w{2}\d{4}$/;this.isValidID=function(e){var t=i(e);return s.test(t)},this.getObjectData=function(e){var t=i(e),o="id="+t;return n(o)},this.getObjectField=function(e,t){var o=i(e),r="id="+o+"&field="+t;return n(r)},o()}function ObjectInfoController(e,t,n,o){var i=this;this.loading=!1,this.error=null,this.object=o,this.info=null,this.isolated="isolated"in o.userData,this.crossSectionSet=!1,"id"in o.userData&&(i.loading=!0,t.getObjectData(o.userData.id).then(function(e){var t=e.data;t.error?i.error=t.error:i.info=t,i.loading=!1},function(e){i.error="Data could not be retrieved",i.loading=!1})),this.isolateObject=function(){n.isolateObject(i.object),i.isolated=!0},this.deisolateObject=function(){n.stopIsolation(),i.isolated=!1},this.setCrossSection=function(){n.setCrossSectionToObjectPosition(i.object),i.crossSectionSet=!0},this.keyHandler=function(t){(13==t.keyCode||27==t.keyCode)&&e.close()},this.ok=function(){e.close()}}function ObjectInfoModalService(e){this.openModal=function(t){var n=e.open({templateUrl:"app/ObjectInfo/ObjectInfoView.html",controller:"ObjectInfoController as modalCtrl",backdrop:!1,size:"md",resolve:{object:function(){return t}}});n.result.then(function(){},function(e){console.warn("Object info popup couldn't be opened. Error.")})}}function ModelServiceStatic(){var e=[new Model(0,"Box","models/Box/Box.obj",ModelFormat.OBJMTL,{unit:"cm",transform:new Transform(0,0,0,3,3,3),mtlPath:"models/Box/Box.mtl"}),new Model(1,"KARSYS Model 1","models/KARSYS_1/KARSYS_1.dae",ModelFormat.DAE,{transform:new Transform(10,10,10,5,5,5)}),new Model(2,"ISSKA 3D (level 6)","models/ISSKA_3D/Model_isska3d_6.dae",ModelFormat.DAE,{coordinatesTransform:new Transform(1e3,100,0,1,1,1),unit:"km",transform:new Transform(0,0,0,.1,.1,.1)}),new Model(3,"Tunnel","models/Tunnel/Tunnel.dae",ModelFormat.DAE),new Model(4,"ArcGIS Test","models/ArcGIS_Test/ArcGIS_Test.dae",ModelFormat.DAE),new Model(5,"ArcGIS Test (Boxes)","models/ArcGIS_Test/ArcGIS_Test2.dae",ModelFormat.DAE)];this.getAll=function(){return e},this.getByID=function(t){for(var n=0;n<e.length;n++)if(e[n].id===t)return e[n]}}function ModelController(e,t,n,o){function i(){for(var e=c.getObjectHierarchy(),t=0;t<e.length;t++){var n=e[t];n.traverse(function(e){if(d.isValidID(e.name)){var t=e.name;e.userData.id=t,d.getObjectField(t,"name").then(function(t){if(t.data.fields){var n=t.data.fields[0].value;null!=n&&n.length>0&&(e.name=n)}})}})}}function r(e,t){if(!t)return e;var n={x:0,y:0,z:0};return t.scale&&(n.x=e.x*t.scale.x,n.y=e.y*t.scale.y,n.z=e.z*t.scale.z),n.x=e.x+t.offset.x,n.y=e.y+t.offset.y,n.z=e.z+t.offset.z,n}function s(){o.$on("MODEL_LOADED",function(e,t){i(),t.params.unit?a.coordinatesUnit=t.params.unit:a.coordinatesUnit="",t.params.transform&&(l.translateObject(t.name,t.params.transform.offset),l.scaleObject(t.name,t.params.transform.scale)),a.csMode=!1,a.csShowPlane=!1,l.centerScene(),l.zoomToScene(),o.$broadcast("UPDATE")})}var a=this,c=e,l=t,d=n;this.movementEnabled=!0,this.coordinatesEnabled=!1,this.model=null,this.mouseCoordinates={x:0,y:0,z:0},this.coordinatesUnit="",this.csMode,this.csFlipped,this.csShowPlane=!1,this.crossSection=l.crossSection,this.toggleCrossSection=function(e){e?l.enableCrossSection(a.crossSection.distance):l.disableCrossSection()},this.toggleCrossSectionPlane=function(e){e=e===!0,l.showCrossSectionPlane(e)},this.moveCrossSection=function(){l.moveCrossSection(a.crossSection.distance)},this.rotateCrossSection=function(e,t,n){var o=t-n;l.rotateCrossSection(e,o)},this.flipCrossSection=function(){l.flipCrossSection()},this.canvasMouseMoved=function(e){var t=0!==e.buttons;if(this.coordinatesEnabled&&!t){var n=c.getMouseWorldCoordinates(e);n&&(this.mouseCoordinates=r(n,a.model.params.coordinatesTransform))}},s()}var ModelFormat={OBJ:0,OBJMTL:1,DAE:2},Transform=function(e,t,n,o,i,r){this.offset={x:e,y:t,z:n},this.scale={x:o,y:i,z:r}},Model=function(e,t,n,o,i){this.id=e,this.name=t,this.filePath=n,this.fileFormat=o,this.params={},i&&(this.params=i)},app=angular.module("karsys",["ui.bootstrap"]);app.value("canvasID","canvas"),app.value("arcGisAPI","http://localhost/backend/gisapi.php"),app.service("ModelRepo",ModelServiceStatic),app.service("GraphicsService",["canvasID","$timeout",GraphicsService]),app.service("SceneUtilsService",["GraphicsService",SceneUtilsService]),app.service("ObjectDataService",["arcGisAPI","$http",ArcGisService]),app.service("ObjectInfoModalService",["$uibModal",ObjectInfoModalService]),app.controller("ModelController",["GraphicsService","SceneUtilsService","ObjectDataService","$scope",ModelController]),app.controller("ObjectInfoController",["$uibModalInstance","ObjectDataService","SceneUtilsService","object",ObjectInfoController]),app.directive("vkModelList",["ModelRepo","GraphicsService","SceneUtilsService",ModelListDirective]),app.directive("vkControls",["GraphicsService",ControlsDirective]),app.directive("vkModelHierarchy",["GraphicsService","SceneUtilsService","ObjectInfoModalService","$timeout",HierarchyDirective]),app.filter("listObjectInTree",function(){return function(e){for(var t=[],n=0;n<e.length;n++){var o=e[n];o.name.length>0&&t.push(o)}return t}}),app.filter("capitalize",function(){return function(e){return e?e.charAt(0).toUpperCase()+e.substr(1):""}}),app.filter("fixDecimals",function(){return function(e,t){return parseFloat(e).toFixed(t)}});